# OnnxRunner æ¨¡å—æ–‡æ¡£
## ğŸ“˜ ç®€ä»‹
ONNXRunneræ˜¯ä¸€ä¸ªä¾æ‰˜äºLingerä¸»ä½“åŠŸèƒ½å¼€å‘çš„è½»é‡çº§æ¨ç†æ¨¡å—ï¼Œç”¨äºç›´æ¥åŠ è½½ ONNX æ¨¡å‹å¹¶åŸºäºç»™å®šè¾“å…¥ï¼ˆ`torch.Tensor`ï¼‰æ‰§è¡Œæ¨ç†ã€‚  å®ƒåŒæ—¶æ”¯æŒä¸­é—´ Tensor çš„è‡ªåŠ¨ dumpï¼Œç”¨äºç»“æœéªŒè¯ä¸è°ƒè¯•ã€‚

## âš™ï¸ å®‰è£…ä¸ä¾èµ–
OnnxRunner éš Linger ä¸€èµ·å‘å¸ƒï¼Œæ— éœ€å•ç‹¬å®‰è£…ã€‚
## ğŸš€ ä½¿ç”¨ç¤ºä¾‹
```python
import torch
from linger.checker.onnxrunner import OnnxRunner
# åˆ›å»ºOnnxRunnerå®ä¾‹
model = OnnxRunner("data.ignore/conv_linear.onnx", dump=True, dump_format='all')
# åˆ›å»ºéšæœºè¾“å…¥
input_tensor = torch.randn(1, 3, 64, 64)
# è·å–æ¨ç†ç»“æœ
output = model.run([input_tensor])
```
## ğŸ§© å‚æ•°è¯´æ˜
| å‚æ•°å           | ç±»å‹     | é»˜è®¤å€¼     | è¯´æ˜                                         |
| ------------- | ------ | ------- | ------------------------------------------ |
| `model_path`  | `str`  | æ—        | ONNX æ¨¡å‹æ–‡ä»¶è·¯å¾„ï¼Œå¿…é¡»æä¾›                                |
| `dump`        | `bool` | `False` | æ˜¯å¦å¯ç”¨ä¸­é—´ Tensor dump åŠŸèƒ½                       |
| `dump_format` | `str`  | `'all'` | dump è¾“å‡ºæ ¼å¼ï¼Œå¯é€‰ `'all'` / `'int'` / `'float'` |
## ğŸ§© API-run()
### å‡½æ•°å®šä¹‰
```python
def run(self, data, special_key='None', out_type="list"):
```
### å‚æ•°è¯´æ˜
| å‚æ•°å           | ç±»å‹                                    | é»˜è®¤å€¼      | è¯´æ˜                                                                                            |
| ------------- | ------------------------------------- | -------- | --------------------------------------------------------------------------------------------- |
| `data`        | `torch.Tensor` æˆ– `List[torch.Tensor]` | å¿…å¡«       | æ¨¡å‹è¾“å…¥æ•°æ®ã€‚å½“æ¨¡å‹æœ‰å¤šä¸ªè¾“å…¥æ—¶ï¼Œå¯ä¼ å…¥å¼ é‡åˆ—è¡¨ï¼Œé¡ºåºä¸æ¨¡å‹è¾“å…¥èŠ‚ç‚¹å®šä¹‰ä¸€è‡´ã€‚                                                       |
| `special_key` | `str` æˆ– `None`                        | `'None'` | ç”¨äºæŒ‡å®šä¸€ä¸ªä¸­é—´Tensorï¼Œä¾¿äºå¯¼å‡ºè¯¥èŠ‚ç‚¹çš„è¾“å‡ºç»“æœã€‚è‹¥è®¾ç½®æ­¤å€¼ä¸” `out_type="dict"`ï¼Œä¼šåœ¨è¾“å‡ºå­—å…¸ä¸­é¢å¤–åŒ…å« `{special_key: tensor}` é”®å€¼å¯¹ã€‚ |
| `out_type`    | `str`                                 | `"list"` | æ§åˆ¶è¾“å‡ºæ ¼å¼ï¼š<br> - `"list"`ï¼šè¾“å‡ºä¸ºæŒ‰èŠ‚ç‚¹é¡ºåºæ’åˆ—çš„å¼ é‡åˆ—è¡¨ï¼›<br> - `"dict"`ï¼šè¾“å‡ºä¸ºä»¥èŠ‚ç‚¹åä¸ºé”®çš„å­—å…¸å½¢å¼ã€‚                        |
### è¿”å›å€¼è¯´æ˜
| è¿”å›ç±»å‹                      | è¯´æ˜                                                            |
| ------------------------- | ------------------------------------------------------------- |
| `List[torch.Tensor]`      | é»˜è®¤è¿”å›ï¼Œä¾æ¬¡åŒ…å«æ¨¡å‹è¾“å‡ºèŠ‚ç‚¹çš„ç»“æœã€‚                                           |
| `Dict[str, torch.Tensor]` | å½“ `out_type="dict"` æ—¶è¿”å›ï¼Œä»¥èŠ‚ç‚¹åä¸ºé”®ã€‚è‹¥æŒ‡å®šäº† `special_key`ï¼Œè¯¥é”®ä¹Ÿä¼šåŒ…å«åœ¨ç»“æœä¸­ã€‚ |
### ç¤ºä¾‹
#### 1ï¸âƒ£ é»˜è®¤ä½¿ç”¨ list è¾“å‡º
```python
input_tensor = torch.randn(1, 3, 64, 64)
output_list = model.run([input_tensor])
print(type(output_list))  # <class 'list'>
```
#### 2ï¸âƒ£ ä½¿ç”¨ dict è¾“å‡º
```python
output_dict = model.run([input_tensor], out_type="dict")
print(output_dict.keys())  # dict_keys(['output_0'])
```
#### 3ï¸âƒ£ å¯¼å‡ºä¸­é—´å±‚ç»“æœ
```python
output_with_mid = model.run([input_tensor], special_key="1123", out_type="dict")
print(output_with_mid.keys())  # dict_keys(['Conv_3', 'output_0'])
```
## ğŸ§ª Dump åŠŸèƒ½è¯´æ˜
å½“ `dump=True` æ—¶ï¼ŒOnnxRunner ä¼šåœ¨`./dump`ä¸‹ç”Ÿæˆæ¨ç†è¿‡ç¨‹çš„ä¸­é—´ç»“æœï¼Œç”¨äºç®—å­çº§åˆ«éªŒè¯ä¸è°ƒè¯•ã€‚
`dump_format` å‚æ•°ç”¨äºæ§åˆ¶ **dump çš„æ•°æ®ç±»å‹ä¸ä¿å­˜è·¯å¾„**ï¼Œæ”¯æŒä»¥ä¸‹ä¸‰ç§æ¨¡å¼ï¼š
| dump_format | è¯´æ˜ | è¾“å‡ºå†…å®¹ | Dump è·¯å¾„ |
|--------------|------|-----------|------------|
| `'all'` | åŒæ—¶å¯¼å‡ºæµ®ç‚¹ä¸å®šç‚¹ç»“æœ | æµ®ç‚¹ç»“æœä¸å®šç‚¹ç»“æœ | `./dump/float/` å’Œ `./dump/int/` |
| `'float'` | ä»…å¯¼å‡ºæµ®ç‚¹ç»“æœ | æµ®ç‚¹å¼ é‡ï¼ˆFP32ï¼‰ | `./dump/float/` |
| `'int'` | ä»…å¯¼å‡ºå®šç‚¹ç»“æœ | å®šç‚¹å¼ é‡ï¼ˆINT8 / INT16 / INT32ï¼‰ | `./dump/int/` |
---